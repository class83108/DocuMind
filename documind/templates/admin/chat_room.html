{% extends "admin/base_site.html" %}
{% load static %}
{% block extrahead %}
    <link rel="stylesheet" href="/static/css/chat.css">
    <script src="https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js" defer></script>
    <script src="https://unpkg.com/htmx.org@2.0.3"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    {% endblock %}
    {% block pretitle %}
    <div class=title-group>
        <h1>Chat Room</h1>
        <h2>{{ room_name }}</h2>
    </div>
    {% endblock %}
    {% block content %}
    <div id="chat-container" x-data="chatApp()" class="chat-container">
        <div class="chat-group">
            <div id="chat-messages" class="chat-messages">
                <template x-for="message in messages">
                    <div :class="['message', message.type + '-message']">
                        <span x-text="message.text"></span>
                    </div>
                </template>
            </div>
            <div id="chat-input" class="chat-input">
                <textarea 
                x-model="newMessage" 
                @compositionstart="isComposing = true"
                @compositionend="isComposing = false"
                @keydown="handleKeydown"
                @input="adjustTextareaHeight"
                placeholder="輸入訊息..." 
                class="query-input"
                rows="1"
                x-ref="messageInput"></textarea>
                <button  class="send-btn" @click="sendMessage">Send</button>
            </div>
        </div>
        <div class="file-group">
            <form id="upload-form">
                {% csrf_token %}
                <div class="input-container">
                    <input type="file" id="pdf_file" name="pdf_file" accept="application/pdf"
                        hx-post="{% url 'api:upload-pdf-and-save' %}"
                        hx-trigger="change"
                        hx-swap="beforeend"
                        hx-encoding="multipart/form-data"
                        hx-vals='{"chat_room_name": "{{ room_name }}"}'
                        >
                        
                </div>
            </form>
            <div id="file-container">
                <ul id="file-list" class="file-list"></ul>
            </div>
        </div>
    </div>
    <script>
        function chatApp() {
            return {
                messages: [],
                newMessage: '',
                socket: null,
                isComposing: false,
                init() {
                    this.messages = [];
                    this.connectWebSocket();
                    this.$nextTick(() => {
                        this.adjustTextareaHeight();
                    });
                },
                connectWebSocket() {
                    const roomName = '{{ room_name }}';
                    this.socket = new WebSocket(
                        'ws://' + window.location.host + '/ws/chat/' + roomName + '/'
                    );
            
                    this.socket.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        if (data.type === 'loading') {
                            console.log("Received loading message");
                            this.addMessage(data.message, 'system');
                        } else if (data.type === 'message') {
                            console.log("Received message");
                            this.handleIncomingMessage(data);
                        } else if (data.type === 'history') {
                            this.handleHistoryMessages(data.messages);
                        }
                    };
            
                    this.socket.onclose = (event) => {
                        console.error('Chat socket closed unexpectedly');
                    };
                },
                handleIncomingMessage(data) {
                    
                    if (this.messages.length > 0 && this.messages[this.messages.length - 1].type === 'system') {
                        this.messages = this.messages.slice(0, -1);
                    }
                    if (data.sender === "DocuMind") {
                        this.addMessage(data.message, 'bot');
                    } else if (data.sender && data.sender !== "DocuMind") {
                        this.addMessage(data.message, 'user');
                    } else {
                        this.addMessage(data.message, 'bot');
                    }
                },
                handleHistoryMessages(messages) {
                    this.messages = messages.map(msg => ({
                        id: `msg_${this.messages.length}_${Date.now()}`,
                        text: msg.message,
                        type: msg.sender === 'DocuMind' ? 'bot' : 'user'
                    }));
                    
                },
                sendMessage() {
                    if (this.newMessage.trim() === '') return;
                    this.addMessage(this.newMessage, 'user');
                    this.socket.send(JSON.stringify({
                        'message': this.newMessage
                    }));
                    this.newMessage = '';
                    this.$nextTick(() => {
                        this.adjustTextareaHeight();
                    });
                },
                addMessage(text, type) {
                    const message = {
                        id: `msg_${this.messages.length}_${Date.now()}`,
                        text: text,
                        type: type
                    };
                    this.messages.push(message);
                    this.$nextTick(() => {
                        const chatMessages = document.getElementById('chat-messages');
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    });
                },
                handleKeydown(event) {
                    if (event.key === 'Enter') {
                        if (event.shiftKey) {
                            // Shift+Enter: add newline
                            return;
                        } else if (!this.isComposing) {
                            // Enter without shift and not composing: send message
                            event.preventDefault();
                            this.sendMessage();
                        }
                    }
                },
                adjustTextareaHeight() {
                    const textarea = this.$refs.messageInput;
                    textarea.style.height = 'auto';
                    textarea.style.height = textarea.scrollHeight + 'px';
                }
            }
        }
    </script>

    <script>
        document.body.addEventListener('htmx:afterRequest', function(event) {
            if (event.detail.successful) {
                var response = JSON.parse(event.detail.xhr.responseText);
                if (response.success) {
                    var fileItem = document.createElement('li');
                    fileItem.className = 'pdf-file-item';
                    fileItem.innerHTML = `
                        <span class="pdf-icon"><i class="fa-solid fa-file-pdf"></i></span>
                        <span class="file-name">${response.file_name}</span>
                    `;
                    document.getElementById('file-list').appendChild(fileItem);
                    
                    // 清除文件輸入
                    document.getElementById('pdf_file').value = '';
                }
            }
        });
        </script>
  
    {% endblock %}